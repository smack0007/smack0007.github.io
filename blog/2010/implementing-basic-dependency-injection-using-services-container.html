<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"><meta name="description" content=""><meta name="author" content="Zachary Snow"><title>Implementing basic Dependency Injection using a Service Container</title><base href="https://smack0007.github.io"></base><link rel="stylesheet" type="text/css" href="css/style.css"><link rel="alternate" type="application/rss+xml" title="The Blog of Zachary Snow" href="feed.rss"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"></head><body><div class="wrap"><nav class="navbar navbar-expand-lg navbar-dark bg-dark"><h1><a class="navbar-brand" href="/">The Blog of Zachary Snow</a></h1><button id="navbar-toggler" class="navbar-toggler" type="button" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav mr-auto"><li class="nav-item"><a class="nav-link active" href="index.html">Home<span class="sr-only">(current)</span></a></li><li class="nav-item"><a class="nav-link" href="about.html">About</a></li><li class="nav-item"><a class="nav-link" href="tags/index.html">Tags</a></li></ul><div class="social my-2 my-lg-0"><a href="https://twitter.com/smack0007" class="twitter" title="Twitter"><span class="icon-twitter"></span></a><a href="https://github.com/smack0007" class="github" title="Github"><span class="icon-github"></span></a><a href="https://paypal.me/smack0007" class="coffee" title="Buy me a Coffee"><span class="icon-mug"></span></a><a href="feed.rss" class="rss" title="RSS"><span class="icon-rss"></span></a></div></div></nav><main class="container"><div class="posts"><div class="post"><div class="post-header"><h2><a href="blog/2010/implementing-basic-dependency-injection-using-services-container.html">Implementing basic Dependency Injection using a Service Container</a></h2><div class="meta"><span class="date"><span class="icon-calendar"></span>June 21, 2010</span><span class="tags"><a href="tags/net/index.html"><span class="icon icon-price-tags"></span><span class="tagName">.net</span></a><a href="tags/csharp/index.html"><span class="icon icon-price-tags"></span><span class="tagName">c#</span></a><a href="tags/dependency-injection/index.html"><span class="icon icon-price-tags"></span><span class="tagName">dependency-injection</span></a><a href="tags/design-patterns/index.html"><span class="icon icon-price-tags"></span><span class="tagName">design-patterns</span></a><a href="tags/service-container/index.html"><span class="icon icon-price-tags"></span><span class="tagName">service-container</span></a></span></div></div><div class="content"><p>By extending your Service Container class, a very basic version of dependency injection can be implemented. We&#39;ll implement two forms of dependency injection: constructor and property injection. </p>
<!--more-->

<p>We&#39;ll start by defining the <strong>Injectable</strong> attribute. </p>
<pre><code class="hljs c#">[<span class="hljs-meta">AttributeUsage(AttributeTargets.Constructor | AttributeTargets.Property,
    AllowMultiple = false, Inherited = true)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InjectableAttribute</span> : <span class="hljs-title">Attribute</span>
{
}
</code></pre>
<p>We&#39;ll use this attribute to mark our constructors and properties for dependency injection. Next we&#39;ll define an interface for our dependency injector:</p>
<pre><code class="hljs c#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IDependencyInjector</span>
{
    T Construct&amp;lt;T&amp;gt;();
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Inject</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> instance</span>)</span>;
}
</code></pre>
<p>We&#39;ll define our service container like so:</p>
<pre><code class="hljs c#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ServiceContainer</span> : <span class="hljs-title">IDependencyInjector</span>, <span class="hljs-title">IServiceProvider</span>
{
    Dictionary&amp;lt;Type, Object&amp;gt; services;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ServiceContainer</span>()
        : <span class="hljs-title">base</span>()</span>
    {
        <span class="hljs-keyword">this</span>.services = <span class="hljs-keyword">new</span> Dictionary&amp;lt;Type, <span class="hljs-built_in">object</span>&amp;gt;();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddService</span>(<span class="hljs-params">Type type, Object provider</span>)</span>
    {
        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> == type)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-string">&quot;type&quot;</span>);

        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> == provider)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-string">&quot;provider&quot;</span>);

        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.services.ContainsKey(type))
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;A provider is already registered the type &quot;</span> + type);

        <span class="hljs-keyword">var</span> providerType = provider.GetType();

        <span class="hljs-keyword">if</span>(!type.IsAssignableFrom(providerType))
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(providerType + <span class="hljs-string">&quot; is not an instance of &quot;</span> + type);

        <span class="hljs-keyword">this</span>.services.Add(type, provider);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">object</span> <span class="hljs-title">GetService</span>(<span class="hljs-params">Type type</span>)</span>
    {
        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> == type)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-string">&quot;type&quot;</span>);

        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.services.ContainsKey(type))
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.services[type];
                    
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RemoveService</span>(<span class="hljs-params">Type type</span>)</span>
    {
        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> == type)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-string">&quot;type&quot;</span>);

        <span class="hljs-keyword">this</span>.services.Remove(type);
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-built_in">object</span> <span class="hljs-title">GetInjectableService</span>(<span class="hljs-params">Type type</span>)</span>
    {
        <span class="hljs-keyword">if</span>(type == <span class="hljs-keyword">typeof</span>(IDependencyInjector) ||
           type == <span class="hljs-keyword">typeof</span>(IServiceProvider))
        {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }
        <span class="hljs-keyword">else</span>
        {
            <span class="hljs-built_in">object</span> service = <span class="hljs-keyword">this</span>.GetService(type);

            <span class="hljs-keyword">if</span>(service == <span class="hljs-literal">null</span>)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to find &quot;</span> + type + <span class="hljs-string">&quot; depenedency.&quot;</span>);

            <span class="hljs-keyword">return</span> service;
        }
    }

    <span class="hljs-keyword">public</span> T Construct&amp;lt;T&amp;gt;()
    {
        ConstructorInfo injectableConstructor = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">foreach</span>(<span class="hljs-function">ConstructorInfo constructor <span class="hljs-keyword">in</span> <span class="hljs-title">typeof</span>(<span class="hljs-params">T</span>).<span class="hljs-title">GetConstructors</span>())</span>
        {
            <span class="hljs-keyword">foreach</span>(Attribute attribute <span class="hljs-keyword">in</span> constructor.GetCustomAttributes(<span class="hljs-literal">true</span>))
            {
                <span class="hljs-keyword">if</span>(attribute <span class="hljs-keyword">is</span> InjectableAttribute)
                {
                    injectableConstructor = constructor;
                    <span class="hljs-keyword">break</span>;
                }
            }

            <span class="hljs-keyword">if</span>(injectableConstructor != <span class="hljs-literal">null</span>)
                <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-keyword">if</span>(injectableConstructor == <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;No injectable constructor found.&quot;</span>);

        <span class="hljs-keyword">var</span> parameters = injectableConstructor.GetParameters();
        <span class="hljs-keyword">var</span> services = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>[parameters.Length];

        <span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">foreach</span>(ParameterInfo parameter <span class="hljs-keyword">in</span> parameters)
            services[i++] = GetInjectableService(parameter.ParameterType);

        <span class="hljs-keyword">return</span> (T)injectableConstructor.Invoke(services);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Inject</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> instance</span>)</span>
    {
        <span class="hljs-keyword">foreach</span>(PropertyInfo property <span class="hljs-keyword">in</span> instance.GetType().GetProperties())
        {
            <span class="hljs-keyword">foreach</span>(Attribute attribute <span class="hljs-keyword">in</span> property.GetCustomAttributes(<span class="hljs-literal">true</span>))
            {
                <span class="hljs-keyword">if</span>(attribute <span class="hljs-keyword">is</span> InjectableAttribute)
                {
                    <span class="hljs-keyword">if</span>(!property.CanWrite)
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(property.Name + <span class="hljs-string">&quot; is marked as Injectable but not writable.&quot;</span>);

                    property.SetValue(instance, GetInjectableService(property.PropertyType), <span class="hljs-literal">null</span>);
                }
            }
        }
    }
}
</code></pre>
<p>You can now construct new instances and inject dependencies on existing instances. Some usage examples:</p>
<pre><code class="hljs c#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IFoo</span>
{
    <span class="hljs-built_in">int</span> Value { <span class="hljs-keyword">get</span>; }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> : <span class="hljs-title">IFoo</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Value
    {
        <span class="hljs-keyword">get</span>;
        <span class="hljs-keyword">set</span>;
    }

    [<span class="hljs-meta">Injectable</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Foo</span>()</span>
    {
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DoIt</span>()</span>
    {
        Console.WriteLine(<span class="hljs-keyword">this</span>.Value);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IBar</span>
{
    <span class="hljs-built_in">string</span> Value { <span class="hljs-keyword">get</span>; }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Bar</span> : <span class="hljs-title">IBar</span>
{
    IFoo foo;

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Value
    {
        <span class="hljs-keyword">get</span>;
        <span class="hljs-keyword">set</span>;
    }

    [<span class="hljs-meta">Injectable</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Bar</span>(<span class="hljs-params">IFoo foo</span>)</span>
    {
        <span class="hljs-keyword">this</span>.foo = foo;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DoIt</span>()</span>
    {
        Console.WriteLine(<span class="hljs-keyword">this</span>.Value + <span class="hljs-string">&quot;: &quot;</span> + <span class="hljs-keyword">this</span>.foo.Value);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Baz</span>
{
    [<span class="hljs-meta">Injectable</span>]
    <span class="hljs-keyword">public</span> IFoo Foo
    {
        <span class="hljs-keyword">get</span>;
        <span class="hljs-keyword">set</span>;
    }

    [<span class="hljs-meta">Injectable</span>]
    <span class="hljs-keyword">public</span> IBar Bar
    {
        <span class="hljs-keyword">get</span>;
        <span class="hljs-keyword">set</span>;
    }
                            
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DoIt</span>()</span>
    {
        Console.WriteLine(<span class="hljs-keyword">this</span>.Bar.Value + <span class="hljs-string">&quot; | &quot;</span> + <span class="hljs-keyword">this</span>.Foo.Value);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
    {
        <span class="hljs-keyword">var</span> container = <span class="hljs-keyword">new</span> ServiceContainer();

        <span class="hljs-keyword">var</span> foo = container.Construct&amp;lt;Foo&amp;gt;();
        foo.Value = <span class="hljs-number">5</span>;
        container.AddService(<span class="hljs-keyword">typeof</span>(IFoo), foo);

        <span class="hljs-keyword">var</span> bar = container.Construct&amp;lt;Bar&amp;gt;();
        container.AddService(<span class="hljs-keyword">typeof</span>(IBar), bar);
        bar.Value = <span class="hljs-string">&quot;Hello World!&quot;</span>;
        bar.DoIt();

        <span class="hljs-keyword">var</span> baz = <span class="hljs-keyword">new</span> Baz();
        container.Inject(baz);
        baz.DoIt();
    }
}
</code></pre>
</div></div></div><div class="clear"></div></main><footer class="p-13 p-md-5 mt-5 text-center text-muted bg-light"><div class="container"><ul class="links"><li><a href="https://twitter.com/smack0007" class="twitter" title="Twitter">Twitter</a></li><li><a href="https://github.com/smack0007" class="github" title="Github">GitHub</a></li><li><a href="https://paypal.me/smack0007" class="coffee" title="Buy me a Coffee">Buy me a Coffee</a></li><li><a href="feed.rss" class="rss" title="RSS">RSS</a></li></ul><p class="mb-0">The Blog of Zachary Snow</p></div></footer></div><script type="text/javascript">document.getElementById('navbar-toggler').onclick = function(){ document.getElementById('navbarSupportedContent').classList.toggle('collapse'); };</script></body></html>